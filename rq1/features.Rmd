---
title: "RQ1 - Features"
output: html_notebook
---

```{r}
library(tidyverse)
library(Rnalytica)
```


# Data

## Load data

```{r}
data = read.csv("../data/rq1/rq1_all_norm.csv", header = TRUE)
```

```{r}
data %>% count(project)
```

Display all columns

```{r}
colnames(data)
```

## Variables

Dependent/target variable

```{r}
target_var = 'pos_vote'
```

```{r}
data %>% count(pos_vote)
```

Patch variables

```{r}
patch_vars = c(
  'num_lines_added',
  'num_lines_deleted',
  'num_lines_of_code', # number of lines in the files before the change
  'num_file_impacted',
  'num_dirs_impacted',
  'mean_complexity', # average Cyclomatic Complexity
  'entropy', # dispersion of modified lines across files
  'bug_fixing', # whether or not the patch is for fixing bugs
  'description_length',
  'num_prior_commits', # number of prior patches that impact the same modified lines
  'num_prior_commits_bug_fixing',
  'avg_prior_age', # average of time intervals (in days) between prior patches and this patch
  'author_is_core', # is author a core developer
  'author_is_exp_author', # % of prior patches that were made by the same author > 0.05
  'author_is_exp_reviewer'
)
```

Dynamic variables

```{r}
dynamic_vars = c(
  'num_prior_comments',
  'num_prior_votes',
  'pct_prior_pos_votes', # % of votes that are positive
  'pct_prior_pos_votes_core', # % of positive votes that come from core devs
  'pct_prior_neg_votes_core'
)
```


Reviewer variables

```{r}
reviewer_vars = c(
  'reviewer_freq', # % of prior patches the author written AND reviewed by reviewer
  'pct_prior_comments_by_reviewer',
  'reviewer_is_core',
  'reviewer_is_exp_author', # % of prior patches that were made by the reviewer > 0
  'reviewer_is_exp_reviewer'
)
```

All variables

```{r}
all_vars = c(patch_vars, dynamic_vars, reviewer_vars)
```

Check if all variables are in column

```{r}
for (v in all_vars){
  if (!is.element(v, colnames(data))){
    print(v)
  }
}
```

Check which columns are not in vars


```{r}
for (col in colnames(data)){
  if (!is.element(col, all_vars)){
    print(col)
  }
}
```

# Correlation Analysis

Visualize pair-wise correlations (note that categorical variables are not inside)

```{r, fig.width=10, fig.height=8}
plotVarClus(dataset = data,
            metrics = all_vars,
            correlation = "spearman",
            correlation.threshold = 0.7)
```

Conduct AutoSpearman

```{r}
vars_survived = AutoSpearman(dataset = data,
                             metrics = all_vars,
                             spearman.threshold = 0.7,
                             verbose = TRUE)
```

Survived variables

```{r}
vars_survived
```

Eliminated variables

```{r}
for (v in all_vars){
  if (!is.element(v, vars_survived)){
    print(v)
  }
}
```

Survived variabels for each category

```{r}
patch_vars_survived = patch_vars[patch_vars %in% vars_survived]
print(patch_vars_survived)
```

```{r}
dynamic_vars_survived = dynamic_vars[dynamic_vars %in% vars_survived]
print(dynamic_vars_survived)
```

```{r}
reviewer_vars_survived = reviewer_vars[reviewer_vars %in% vars_survived]
print(reviewer_vars_survived)
```

Save

```{r}
save(target_var, patch_vars_survived, dynamic_vars_survived, reviewer_vars_survived, file = "outputs/features.Rdata")
```

# Mixed-Effect Model Formulas

## Null

```{r}
null_form = paste(target_var, ' ~ 1',
                  " + (1 | reviewer_id)")
null_form
```

## Single

Only patch

```{r}
patch_form = paste(target_var, ' ~ ',
                   paste(c(patch_vars_survived), collapse = " + "),
                   " + (1 | reviewer_id)")
patch_form
```

Only dynamic

```{r}
dynamic_form = paste(target_var, ' ~ ',
                     paste(c(dynamic_vars_survived), collapse = " + "),
                     " + (1 | reviewer_id)")
dynamic_form
```

Only patch

```{r}
reviewer_form = paste(target_var, ' ~ ',
                      paste(c(reviewer_vars_survived), collapse = " + "),
                      " + (1 | reviewer_id)")
reviewer_form
```

## Double

Exclude patch

```{r}
ex_patch_form = paste(target_var, ' ~ ',
                      paste(c(dynamic_vars_survived,
                              reviewer_vars_survived), collapse = " + "),
                  " + (1 | reviewer_id)")
ex_patch_form
```

Exclude dynamic

```{r}
ex_dynamic_form = paste(target_var, ' ~ ',
                        paste(c(patch_vars_survived,
                                reviewer_vars_survived), collapse = " + "),
                  " + (1 | reviewer_id)")
ex_dynamic_form
```

Exclude reviewer

```{r}
ex_reviewer_form = paste(target_var, ' ~ ',
                         paste(c(patch_vars_survived,
                                 dynamic_vars_survived), collapse = " + "),
                         " + (1 | reviewer_id)")
ex_reviewer_form
```

## All

```{r}
full_form = paste(target_var, ' ~ ',
                  paste(c(patch_vars_survived,
                          dynamic_vars_survived,
                          reviewer_vars_survived), collapse = " + "),
                  " + (1 | reviewer_id)")
full_form
```

Save

```{r}
save(null_form,
     patch_form, dynamic_form, reviewer_form,
     ex_patch_form, ex_dynamic_form, ex_reviewer_form,
     full_form,
     file = "outputs/formulas.Rdata")
```
